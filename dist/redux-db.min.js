var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__extends=this&&this.__extends||function(){var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();define("types",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("constants",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TYPE_PK="PK",t.TYPE_ATTR="ATTR",t.TYPE_MODIFIED="MODIFIED",t.RESERVED_PROPERTIES=["id","table","value","_fields"],t.initialState=function(){return{ids:[],byId:{},indexes:{}}}}),define("errors",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={argument:function(e,t){return"Missing a valid "+t+' for the argument "'+e+'"'},fkInvalid:function(e,t){return"The foreign key "+e+"."+t+" is invalid"},fkInvalidReference:function(e,t,r){return'The field schema "'+e+"."+t+'" has an invalid reference to unknown table "'+r+'".'},fkReferenceNotInSession:function(e,t){return'The foreign key: "'+e+'" references an unregistered table: "'+t+'" in the current session.'},fkUndefined:function(e,t){return"No foreign key named: "+t+' in the schema: "'+e+'".'},fkViolation:function(e,t){return'The insert/update operation violates the unique foreign key "'+e+"."+t+'".'},invalidId:function(){return'The given value is not a valid "id". An "id" must be a non-empty string or a number.'},pkNotFound:function(e){return'Failed to get primary key for record of type "'+e+'".'},recordNotFound:function(e,t){return'No "'+e+'" record with id: '+t+" exists."},recordUpdateViolation:function(e,t){return'Failed to apply update. No "'+e+'" record with id: '+t+" exists."},reservedProperty:function(e,t){return'The property "'+e+"."+t+'" is a reserved name. Please specify another name using the "propName" definition.'},sessionReadonly:function(){return"Invalid attempt to alter a readonly session."},stateTableUndefined:function(){return"Failed to select table. Could not identify table schema."},tableInvalidState:function(e){return'The table "'+e+'" has an invalid state.'},tableNotInSession:function(e){return'The table: "'+e+'" does not exist in the current session.'},uniqueConstraintViolation:function(e){return'Operation violates unique constraint for id: "'+e+'"'}}}),define("models/DatabaseSession",["require","exports","errors","utils"],function(e,t,n,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(t,e,r){void 0===t&&(t={});var n=this;this.state=t,this.db=e;var i=(this.options=r).tableSchemas||e.tables;this.tables=a.toObject(i.map(function(e){return n.db.factory.newTableModel(n,e,t[e.name])}),function(e){return e.schema.name})}return e.prototype.upsert=function(t){var r=this;if(this.options.readOnly)throw new Error(n.default.sessionReadonly());Object.keys(t.output).forEach(function(e){e!==t.schema.name&&r.tables[e].upsertNormalized(t.output[e])}),Object.keys(t.emits).forEach(function(e){e!==t.schema.name&&r.tables[e].upsert(t.emits[e])})},e.prototype.commit=function(){var i=this;if(this.options.readOnly)throw new Error(n.default.sessionReadonly());return Object.keys(this.tables).forEach(function(e){var t,r=i.state[e],n=i.tables[e].state;r!==n&&(i.state=__assign({},i.state,((t={})[e]=n,t)))}),this.state},e}();t.default=r}),define("models/Database",["require","exports","DefaultModelFactory","utils","models/DatabaseSession"],function(e,t,n,a,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={cascadeAsDefault:!1},o=function(e,t,r){return e?"function"==typeof e?e:e[t]?e[t]:r:r},s=function(){function e(t,e){var r=this;this.getNormalizer=function(e){return o(r.options.onNormalize,e)},this.getPkGenerator=function(e){return o(r.options.onGeneratePK,e)},this.getRecordComparer=function(e){return o(r.options.onRecordCompare,e,a.isEqual)},a.ensureParamObject("schema",t),this.schema=t,this.options=__assign({},i,e),this.factory=this.options.factory||new n.default,this.tables=Object.keys(t).map(function(e){return r.factory.newTableSchema(r,e,t[e])}),this._tableLookup=a.toObject(this.tables,function(e){return e.name}),this.tables.forEach(function(e){return e.connect(r._tableLookup)})}return e.prototype.combineReducers=function(){for(var r=this,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return function(e,t){return void 0===e&&(e={}),r.reduce(e,t,n)}},e.prototype.reduce=function(e,t,r,n){var i=this.createSession(e);return a.ensureArray(r).forEach(function(e){return e(i.tables,t,n)}),i.commit()},e.prototype.createSession=function(e,t){return new r.default(e,this,__assign({readOnly:!1},t))},e.prototype.wrapTables=function(e){var t=this,r=Object.keys(e).filter(function(e){return t._tableLookup[e]}).map(function(e){return t._tableLookup[e]});return this.createSession(e,{readOnly:!0,tableSchemas:r}).tables},e.prototype.selectTables=function(e){return this.wrapTables(e)},e}();t.default=s}),define("models/RecordModel",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.id=r.ensureParam("id",e),this.table=r.ensureParam("table",t)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.getValue(this.id)||{}},set:function(e){this.update(e)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.schema.injectKeys(e,this),this.table.update(e),this},e}();t.default=n}),define("models/RecordSetModel",["require","exports","errors","utils"],function(e,t,n,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this.table=i.ensureParamObject("table",e),this.schema=i.ensureParamObject("schema",t),this.owner=i.ensureParamObject("owner",r)}return Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.getIndex(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var t=this;return this.ids.map(function(e){return t.table.schema.db.factory.newRecordModel(e,t.table)})},e.prototype.values=function(){var r=this;return this.ids.map(function(e){var t=r.table.getValue(e);if(!t)throw new Error(n.default.recordNotFound(r.table.schema.name,e));return t})},e.prototype.add=function(e){return this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var t=this,r=this._normalize(e).map(function(e){return t.table.schema.getPrimaryKey(e)});return this.table.delete(r)},e.prototype.update=function(e){return this.table.update(this._normalize(e))},e.prototype.delete=function(){this.table.delete(this.ids)},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.default=r}),define("models/NormalizeContext",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.output={},this.emits={},this.schema=e,this.db=e.db,this.normalizePKs=t}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.default=r}),define("models/TableState",["require","exports","errors","utils"],function(e,t,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.merge=function(e,t){var r=t.ids?u.mergeIds(e.ids,t.ids,!0):e.ids,n=t.byId?__assign({},e.byId,t.byId):e.byId;return __assign({},e,{byId:n,ids:r})},t.splice=function(e,t){var i=__assign({},e.byId),a=e.ids.slice(),r=__assign({},e.indexes);return{deleted:t.reduce(function(e,t){var r=i[t];delete i[t];var n=a.indexOf(t);return 0<=n&&a.splice(n,1),r?e.concat([{id:t,record:r}]):e},[]),state:__assign({},e,{byId:i,ids:a,indexes:r})}},t.updateIndexes=function(a,e,o){Object.keys(o.indexes).forEach(function(n){var i=e.indexes[n]||(e.indexes[n]={unique:o.indexes[n].unique,values:{}});Object.keys(o.indexes[n].values).forEach(function(e){var t=i.values[e]||(i.values[e]=[]),r=u.mergeIds(t,o.indexes[n].values[e],!1);if(i.unique&&1<r.length)throw new Error(s.default.fkViolation(a,n));i.values[e]=r})})},t.cleanIndexes=function(e,n,i){e.forEach(function(e){var t=-1;if(e.value&&i[e.name]&&i[e.name].values[e.value]&&(t=i[e.name].values[e.value].indexOf(n)),0<=t){var r=i[e.name].values[e.value].slice();r.splice(t,1),i[e.name].values[e.value]=r}else i[e.name]&&(delete i[e.name].values[n],0===Object.keys(i[e.name].values).length&&delete i[e.name])})},t.default={cleanIndexes:t.cleanIndexes,merge:t.merge,splice:t.splice,updateIndexes:t.updateIndexes}}),define("models/TableModel",["require","exports","constants","errors","utils","models/NormalizeContext","models/TableState"],function(e,t,s,u,l,a,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){void 0===r&&(r=s.initialState()),this.dirty=!1,this.session=l.ensureParamObject("session",e),this.schema=l.ensureParamObject("schema",t),this.state=l.ensureParamObject("state",r);var n=this.state,i=n.ids,a=n.byId,o=n.indexes;if(!i||!a||!o)throw new Error(u.default.tableInvalidState(t.name))}return Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var t=this;return this.state.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},e.prototype.values=function(){var t=this;return this.state.ids.map(function(e){return t.state.byId[e]})},e.prototype.exists=function(e){return!!l.isValidID(e)&&void 0!==this.state.byId[l.asID(e)]},e.prototype.get=function(e){if(this.exists(e))return this.schema.db.factory.newRecordModel(l.asID(e),this)},e.prototype.getValue=function(e){return l.isValidID(e)?this.state.byId[e]:void 0},e.prototype.getIndex=function(e,t){return l.ensureParamString("name",e),l.ensureParamString("fk",t),this.state.indexes[e]&&this.state.indexes[e].values[t]?this.state.indexes[e].values[t]:[]},e.prototype.insert=function(e){return this._normalizedAction(e,this.insertNormalized,!0)},e.prototype.update=function(e){return this._normalizedAction(e,this.updateNormalized,!1)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)},e.prototype.delete=function(e){var n=this;l.ensureParam("data",e);var t=l.ensureArray(e).map(function(e){return l.isObject(e)?n.schema.getPrimaryKey(e):l.ensureID(e)});if(!t.length)return 0;this._deleteCascade(t);var r=c.default.splice(this.state,t),i=r.deleted,a=r.state;return i.forEach(function(e){var t=e.id,r=e.record;return n._cleanIndexes(t,r,a.indexes)}),this.dirty=!0,this.state=a,i.length},e.prototype.deleteAll=function(){this.length&&(this._deleteCascade(this.state.ids),this.state=s.initialState())},e.prototype.upsertNormalized=function(t){var r=this;l.ensureParamObject("table",t);var n=s.initialState(),i=s.initialState();t.ids.forEach(function(e){r.exists(e)?(n.ids.push(e),n.byId[e]=t.byId[e]):(i.ids.push(e),i.byId[e]=t.byId[e])}),i.ids.length&&this.insertNormalized(i,!1),n.ids.length&&this.updateNormalized(n,!1),this._updateIndexes(t)},e.prototype.insertNormalized=function(e,t){void 0===t&&(t=!0),l.ensureParamObject("table",e),this.state=c.default.merge(this.state,e),this.dirty=!0,t&&this._updateIndexes(e)},e.prototype.updateNormalized=function(a,e){var o=this;void 0===e&&(e=!0),l.ensureParamObject("table",a);var t=a.ids.reduce(function(e,t){var r;if(!o.exists(t))throw new Error(u.default.recordUpdateViolation(o.schema.name,t));var n=o.state.byId[t],i=__assign({},n,a.byId[t]);if(o.schema.isModified(n,i)){if(!e)return(r={})[t]=i,r;e[t]=i}return e},null);t&&(this.dirty=!0,this.state=c.default.merge(this.state,{byId:t}),e&&this._updateIndexes(a))},e.prototype._normalizedAction=function(e,t,r){l.ensureParam("data",e),l.ensureParamFunction("action",t);var n=new a.default(this.schema,r);this.schema.normalize(e,n);var i=n.output[this.schema.name];return i&&t.call(this,i),this.session.upsert(n),i.ids},e.prototype._cleanIndexes=function(e,t,r){var n=this.schema.getForeignKeys(t);c.default.cleanIndexes(n,e,r)},e.prototype._updateIndexes=function(e){c.default.updateIndexes(this.schema.name,this.state,e)},e.prototype._deleteCascade=function(e){var t=this,n=this.schema.relations.filter(function(e){return e.relationName&&e.cascade});n.length&&e.forEach(function(e){var r=t.get(e);r&&n.forEach(function(e){var t=e.relationName&&r[e.relationName];t&&t.delete()})})},e}();t.default=r}),define("models/FieldSchemaModel",["require","exports","constants","errors","utils"],function(e,t,i,r,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,r,n){this.table=a.ensureParamObject("table",e),this.type=r.type||i.TYPE_ATTR,this.name=r.fieldName||t,this.propName=r.propName||t,this._valueFactory=r.value?r.value.bind(this):null,this.isPrimaryKey=!0===r.pk||r.type===i.TYPE_PK,this.isForeignKey=null!==r.references&&void 0!==r.references,this.isStamp=!0===r.stamp||r.type===i.TYPE_MODIFIED,this.isPrimaryKey||this.isForeignKey?(this.references=r.references,this.relationName=r.relationName,this.cascade=void 0===r.cascade?n:!0===r.cascade,this.unique=!0===r.unique,this.notNull=void 0===r.notNull||!0===r.notNull):(this.cascade=!1,this.unique=!1,this.notNull=!0===r.notNull)}return Object.defineProperty(e.prototype,"refTable",{get:function(){return this._refTable},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){if(this.references&&(this._refTable=e[this.references],!this._refTable))throw new Error(r.default.fkInvalidReference(this.table.name,this.name,this.references))},e.prototype.getValue=function(e,t){return this._valueFactory?this._valueFactory(e,{record:t,schema:this}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.default=n}),define("models/TableSchemaModel",["require","exports","errors","utils","models/FieldSchemaModel"],function(e,t,n,l,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(t,e,r){var n=this;this._relations=[],this.db=l.ensureParam("db",t),this.name=l.ensureParamString("name",e),l.ensureParamObject("schema",r),this.fields=Object.keys(r).map(function(e){return new i.default(n,e,r[e],!0===t.options.cascadeAsDefault)}),this._primaryKeyFields=this.fields.filter(function(e){return e.isPrimaryKey}),this._foreignKeyFields=this.fields.filter(function(e){return e.isForeignKey}),this._stampFields=this.fields.filter(function(e){return e.isStamp})}return Object.defineProperty(e.prototype,"relations",{get:function(){return this._relations},enumerable:!0,configurable:!0}),e.prototype.connect=function(t){var r=this;Object.keys(t).forEach(function(e){return r._relations=r._relations.concat(t[e].fields.filter(function(e){return e.references===r.name}))}),this._foreignKeyFields.forEach(function(e){return e.connect(t)})},e.prototype.normalize=function(e,t){var s=this;if(!l.isObject(e)&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var u=l.ensureParam("context",t);return u.output[this.name]||(u.output[this.name]={ids:[],byId:{},indexes:{}}),l.ensureArray(e).map(function(e){if(!l.isObject(e))throw new Error("Failed to normalize data. Given record is not a plain object.");var t=e,r=s.db.getNormalizer(s.name);r&&(t=r(t,u));var i=u.normalizePKs?s._normalizePrimaryKey(t):s._getPrimaryKey(t);if(!i)throw new Error('Failed to normalize primary key for record of type "'+s.name+'". Make sure record(s) have a primary key value before trying to insert or update a table.');var n=s.getForeignKeys(t),a=u.output[s.name];a.byId[i]||a.ids.push(i);var o=a.byId[i]=__assign({},t);return n.forEach(function(e){if("object"==typeof e.value){var t=e.refTable.normalize(e.value,u);if(1<t.length)throw new Error('Invalid schema definition. The field "'+s.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');o[e.name]=e.value=t[0]}if(l.isValidID(e.value)){var r=l.asID(e.value),n=a.indexes[e.name]||(a.indexes[e.name]={unique:e.unique,values:{}});if(n.values[r]||(n.values[r]=[]),n.unique&&n.values.length)throw new Error('The insert/update operation violates the unique foreign key "'+s.name+"."+e.name+'".');n.values[r].push(i)}}),s.relations.forEach(function(e){if(e.relationName&&o[e.relationName]){var t=s.inferRelations(o[e.relationName],e,i);e.table.normalize(t,u),delete o[e.relationName]}}),i})},e.prototype.inferRelations=function(e,n,i){if(!n.isForeignKey)return e;var a=n.table.fields.filter(function(e){return e.isForeignKey&&e!==n});return l.ensureArray(e).map(function(e){var t,r;return"number"!=typeof e&&"string"!=typeof e||(1===a.length?((t={})[a[0].name]=e,e=t):e={id:e}),__assign({},e,((r={})[n.name]=i,r))})},e.prototype.injectKeys=function(t,r){if(!t||"object"!=typeof t)return t;var e=this._primaryKeyFields;e.length||(e=this._foreignKeyFields),e.forEach(function(e){void 0===t[e.name]&&(t[e.name]=e.getRecordValue(r))})},e.prototype.getPrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t)throw new Error(n.default.pkNotFound(this.name));return t},e.prototype.getForeignKeys=function(t){var r=this;return this._foreignKeyFields.map(function(e){if(!e.references||!e.refTable)throw new Error(n.default.fkInvalid(r.name,e.name));return{name:e.name,notNull:e.notNull,references:e.references,refTable:e.refTable,unique:!0===e.unique,value:t[e.name]}})},e.prototype.isModified=function(r,n){if(0<this._stampFields.length)return this._stampFields.reduce(function(e,t){return e+(t.getValue(r)===t.getValue(n)?1:0)},0)!==this._stampFields.length;var e=this.db.getRecordComparer(this.name);return e?!e(r,n,this):r===n},e.prototype._getPrimaryKey=function(n){var e=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(e,t){var r=t.getValue(n);return e&&r?e+"_"+r:r},null);return l.isValidID(e)&&l.asID(e)},e.prototype._normalizePrimaryKey=function(e){var t=this._getPrimaryKey(e);if(t)return t;var r=this.db.getPkGenerator(this.name);if(r){var n=r(e,this);return n&&1===this._primaryKeyFields.length&&(e[this._primaryKeyFields[0].propName]=n),n}},e}();t.default=r}),define("models/index",["require","exports","models/RecordFieldModel","models/RecordModel","models/RecordSetModel","models/TableModel","models/TableSchemaModel"],function(e,r,t,n,i,a,o){"use strict";function s(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),s(t),s(n),s(i),s(a),s(o)}),define("index",["require","exports","models/Database","constants","DefaultModelFactory","utils"],function(e,r,n,t,i,a){"use strict";function o(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}Object.defineProperty(r,"__esModule",{value:!0}),r.createDatabase=function(e,t){return new n.default(e,t)},o(t),o(i),r.utils=a}),define("utils",["require","exports","errors"],function(e,r,a){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.toArray=function(t){return t?Array.isArray(t)?t:"object"==typeof t?Object.keys(t).map(function(e){return t[e]}):[]:[]},r.ensureArray=function(e){return void 0===e||null==e?[]:Array.isArray(e)?e:[e]},r.isObject=function(e){return null!==e&&!Array.isArray(e)&&"object"==typeof e},r.ensureParam=function(e,t){if(void 0===t)throw new Error(a.default.argument(e,"value"));return t},r.ensureParamString=function(e,t){if(null==t||"string"!=typeof t||0===t.length)throw new Error(a.default.argument(e,"string"));return t},r.ensureParamObject=function(e,t){if(!t||!r.isObject(t))throw new Error(a.default.argument(e,"object"));return t},r.ensureParamFunction=function(e,t){if(!t||"function"!=typeof t)throw new Error(a.default.argument(e,"function"));return t},r.ensureID=function(e){if(!r.isValidID(e))throw new Error(a.default.invalidId());return r.asID(e)},r.isValidID=function(e){return null!=e&&!isNaN(e)&&("string"==typeof e&&0<e.length||"number"==typeof e)},r.asID=function(e){return"string"==typeof e?e:e.toString()},r.toObject=function(e,r){return e.reduce(function(e,t){return e[r(t)]=t,e},{})},r.mergeIds=function(e,t,r){var n,i={};for(n=0;n<e.length;n++)i[e[n]]=!0;for(n=0;n<t.length;n++){if(r&&i[t[n]])throw new Error(a.default.uniqueConstraintViolation(t[n]));i[t[n]]=!0}return Object.keys(i)},r.isEqual=function(e,t){if(e===t)return!0;var r=Object.keys(e),n=Object.keys(t),i=r.length;if(n.length!==i)return!1;for(var a=0;a<i;a++){var o=r[a];if(!(Array.isArray(e[o])&&Array.isArray(t[o])&&s(e[o],t[o]))&&e[o]!==t[o])return!1}return!0};var s=function(e,t){if(e===t)return!0;var r=e.length;if(t.length!==r)return!1;for(var n=0;n<r;n++)if(e[n]!==t[n])return!1;return!0}}),define("models/RecordFieldModel",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.schema=r.ensureParam("schema",e),this.record=r.ensureParam("record",t),this.name=r.ensureParamString("schema.name",e.name)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.default=n}),define("DefaultModelFactory",["require","exports","constants","errors","models/RecordFieldModel","models/RecordModel","models/RecordSetModel","models/TableModel","models/TableSchemaModel"],function(e,t,a,o,i,r,n,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(){this._recordClass={},this._defineProperty=function(e,t,r,n,i){if(void 0===i&&(i=!0),0<=a.RESERVED_PROPERTIES.indexOf(t))throw new Error(o.default.reservedProperty(r.table.name,t));Object.defineProperty(e.prototype,t,{get:function(){return i?this._fields[t]||(this._fields[t]=n(r,this)):n(r,this)}})}}return e.prototype.newTableSchema=function(e,t,r){return new u.default(e,t,r)},e.prototype.newTableModel=function(e,t,r){return new s.default(e,t,r)},e.prototype.newRecordModel=function(e,t){return new(this.createRecordModel(t.schema))(e,t)},e.prototype.newRecordSetModel=function(e,t,r){return new n.default(e,t,r)},e.prototype.getRecordBaseClass=function(e){return r.default},e.prototype.createRecordModel=function(e){var t=this;if(this._recordClass[e.name])return this._recordClass[e.name];var r=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r._fields={},r}return __extends(e,n),e}(this.getRecordBaseClass(e));return e.fields.forEach(function(e){return(e.isForeignKey||!e.isPrimaryKey)&&t._defineProperty(r,e.propName,e,t._newRecordField.bind(t),!1)}),e.relations.forEach(function(e){return e.relationName&&t._defineProperty(r,e.relationName,e,e.unique?t._newRecordRelation.bind(t):t._newRecordSet.bind(t),!e.unique)}),this._recordClass[e.name]=r},e.prototype._newRecordField=function(e,t){if(!e.isForeignKey)return new i.default(e,t);var r=e.references&&t.table.session.tables[e.references];if(!r)throw new Error(o.default.fkReferenceNotInSession(e.name,e.references));var n=e.getRecordValue(t);return void 0===n?null:r.get(n)},e.prototype._newRecordSet=function(e,t){var r=t.table.session.tables[e.table.name];if(!r)throw new Error(o.default.tableNotInSession(e.table.name));return this.newRecordSetModel(r,e,t)},e.prototype._newRecordRelation=function(e,t){var r=t.table.session.tables[e.table.name];if(!r)throw new Error(o.default.tableNotInSession(e.table.name));var n=r.getIndex(e.name,t.id)[0];return void 0===n?null:this.newRecordModel(n,r)},e}();t.default=l});