var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},__extends=this&&this.__extends||function(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}();define("errors",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={argument:function(e,t){return"Missing a valid "+t+' for the argument "'+e+'"'},fkInvalidReference:function(e){return'The foreign key: "'+e+'" does not define a valid referenced table.'},fkReferenceNotInSession:function(e,t){return'The foreign key: "'+e+'" references an unregistered table: "'+t+'" in the current session.'},fkUndefined:function(e,t){return"No foreign key named: "+t+' in the schema: "'+e+'".'},fkViolation:function(e,t){return'The insert/update operation violates the unique foreign key "'+e+"."+t+'".'},recordNotFound:function(e,t){return'No "'+e+'" record with id: '+t+" exists."},recordUpdateNotFound:function(e,t){return'Failed to apply update. No "'+e+'" record with id: '+t+" exists."},reservedProperty:function(e,t){return'The property "'+e+"."+t+'" is a reserved name. Please specify another name using the "propName" definition.'},sessionReadonly:function(){return"Invalid attempt to alter a readonly session."},stateTableUndefined:function(){return"Failed to select table. Could not identify table schema."},tableInvalidState:function(e){return'The table "'+e+'" has an invalid state.'},tableNotInSession:function(e){return'The table: "'+e+'" does not exist in the current session.'}}}),define("types",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("constants",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TYPE_PK="PK",t.TYPE_ATTR="ATTR",t.TYPE_MODIFIED="MODIFIED",t.RESERVED_PROPERTIES=["id","table","value","_fields"],t.INITIAL_STATE={ids:[],byId:{},indexes:{}}}),define("models/RecordFieldModel",["require","exports","utils"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.schema=n.ensureParam("schema",e),this.record=n.ensureParam("record",t),this.name=n.ensureParamString("schema.name",e.name)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.default=r}),define("models/RecordModel",["require","exports","utils"],function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.id=n.ensureParam("id",e),this.table=n.ensureParam("table",t)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.getValue(this.id)||{}},set:function(e){this.update(e)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.schema.injectKeys(e,this),this.table.update(e),this},e}();t.default=r}),define("models/RecordSetModel",["require","exports","utils"],function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n){this.table=r.ensureParam("table",e),this.schema=r.ensureParam("schema",t),this.owner=r.ensureParam("owner",n)}return Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.getIndex(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var t=this;return this.ids.map(function(e){return t.table.schema.db.factory.newRecordModel(e,t.table)})},e.prototype.getValue=function(){return this.all().map(function(e){return e.value})},e.prototype.add=function(e){this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var n=this;this._normalize(e).forEach(function(e){var t=n.table.schema.getPrimaryKey(e);n.table.delete(t)})},e.prototype.update=function(e){return this.table.update(this._normalize(e)),this},e.prototype.delete=function(){var t=this;this.ids.forEach(function(e){return t.table.delete(e)})},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.default=n}),define("models/NormalizeContext",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t){this.output={},this.emits={},this.schema=e,this.db=e.db,this.normalizePKs=t}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.default=n}),define("models/TableModel",["require","exports","constants","errors","utils","models/NormalizeContext"],function(e,t,s,u,l,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n){void 0===n&&(n=s.INITIAL_STATE),this.dirty=!1,this.session=l.ensureParamObject("session",e),this.schema=l.ensureParamObject("schema",t),this.state=l.ensureParamObject("state",n);var r=this.state,i=r.ids,o=r.byId,a=r.indexes;if(!i||!o||!a)throw new Error(u.default.tableInvalidState(t.name))}return Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var t=this;return this.state.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},e.prototype.values=function(){var t=this;return this.state.ids.map(function(e){return t.state.byId[e]})},e.prototype.get=function(e){if(this.exists(e))return this.schema.db.factory.newRecordModel(l.asID(e),this)},e.prototype.getFieldValue=function(e,t){var n=this.get(e);return n?n.value[t]:void 0},e.prototype.getValue=function(e){return l.isValidID(e)?this.state.byId[e]:void 0},e.prototype.getIndex=function(e,t){return l.ensureParamString("value",e),l.ensureParamString("fk",t),this.state.indexes[e]&&this.state.indexes[e].values[t]?this.state.indexes[e].values[t]:[]},e.prototype.exists=function(e){return!!l.isValidID(e)&&void 0!==this.state.byId[l.asID(e)]},e.prototype.insert=function(e){return this._normalizedAction(e,this.insertNormalized,!0)},e.prototype.update=function(e){return this._normalizedAction(e,this.updateNormalized,!1)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)},e.prototype.delete=function(e){if("string"!=typeof e&&"number"!=typeof e&&(e=this.schema.getPrimaryKey(e)),!this.exists(e))return!1;e=l.asID(e),this._deleteCascade(e);var t=__assign({},this.state.byId),n=this.state.ids.slice(),r=__assign({},this.state.indexes),i=t[e];delete t[e];var o=n.indexOf(e);return 0<=o&&n.splice(o,1),i&&this._cleanIndexes(e,i,r),this.dirty=!0,this.state=__assign({},this.state,{byId:t,ids:n,indexes:r}),!0},e.prototype.deleteAll=function(){this.length&&this.all().forEach(function(e){return e.delete()})},e.prototype.insertNormalized=function(e){var t=this;return l.ensureParam("table",e),this.dirty=!0,this.state=__assign({},this.state,{byId:__assign({},this.state.byId,e.byId),ids:l.mergeIds(this.state.ids,e.ids,!0)}),this._updateIndexes(e),e.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},e.prototype.updateNormalized=function(r){var i=this;l.ensureParam("table",r);var o=__assign({},this.state),a=!1,e=Object.keys(r.byId).map(function(e){if(!i.state.byId[e])throw new Error(u.default.recordUpdateNotFound(i.schema.name,e));var t=o.byId[e],n=__assign({},t,r.byId[e]);return i.schema.isModified(t,n)&&(o.byId[e]=n,a=!0),i.schema.db.factory.newRecordModel(e,i)});return a&&(this.dirty=!0,this.state=o,this._updateIndexes(r)),e},e.prototype.upsertNormalized=function(t){var n=this;l.ensureParam("table",t);var r={ids:[],byId:{},indexes:{}},i={ids:[],byId:{},indexes:{}};t.ids.forEach(function(e){n.exists(e)?(r.ids.push(e),r.byId[e]=t.byId[e]):(i.ids.push(e),i.byId[e]=t.byId[e])});var e=(r.ids.length?this.updateNormalized(r):[]).concat(i.ids.length?this.insertNormalized(i):[]);return this._updateIndexes(t),e},e.prototype._normalizedAction=function(e,t,n){l.ensureParam("data",e),l.ensureParam("action",t);var r=new a.default(this.schema,n);this.schema.normalize(e,r);var i=r.output[this.schema.name],o=i?t.call(this,i):[];return this.session.upsert(r),o},e.prototype._updateIndexes=function(o){var a=this;Object.keys(o.indexes).forEach(function(r){var i=a.state.indexes[r]||(a.state.indexes[r]={unique:o.indexes[r].unique,values:{}});Object.keys(o.indexes[r].values).forEach(function(e){var t=i.values[e]||(i.values[e]=[]),n=l.mergeIds(t,o.indexes[r].values[e],!1);if(i.unique&&1<n.length)throw new Error(u.default.fkViolation(a.schema.name,r));i.values[e]=n})})},e.prototype._cleanIndexes=function(r,e,i){this.schema.getForeignKeys(e).forEach(function(e){var t=-1;if(e.value&&i[e.name]&&i[e.name].values[e.value]&&(t=i[e.name].values[e.value].indexOf(r)),0<=t){var n=i[e.name].values[e.value].slice();n.splice(t,1),i[e.name].values[e.value]=n}else i[e.name]&&(delete i[e.name].values[r],0===Object.keys(i[e.name].values).length&&delete i[e.name])})},e.prototype._deleteCascade=function(e){var t=this.schema.relations.filter(function(e){return e.relationName&&e.cascade});if(t.length){var n=this.get(e);n&&t.forEach(function(e){var t=n[e.relationName];t&&t.delete()})}},e}();t.default=n}),define("models/FieldSchemaModel",["require","exports","constants","utils"],function(e,t,i,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e,t,n,r){this.table=o.ensureParam("table",e),this.type=n.type||i.TYPE_ATTR,this.name=t,this.propName=n.propName||t,this._valueFactory=n.value?n.value.bind(this):null,this.isPrimaryKey=n.type===i.TYPE_PK,this.isForeignKey=null!==n.references&&void 0!==n.references,this.isPrimaryKey||this.isForeignKey?(this.references=n.references,this.relationName=n.relationName,this.cascade=void 0===n.cascade?r:!0===n.cascade,this.unique=!0===n.unique,this.notNull=void 0===n.notNull||!0===n.notNull):(this.cascade=!1,this.unique=!1,this.notNull=!0===n.notNull)}return Object.defineProperty(e.prototype,"refTable",{get:function(){return this._refTable},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){var t=this;if(this.references&&(this._refTable=e.filter(function(e){return e.name===t.references})[0],!this._refTable))throw new Error('The field schema "'+this.table.name+"."+this.name+'" has an invalid reference to unknown table "'+this.references+'".')},e.prototype.getValue=function(e,t){return this._valueFactory?this._valueFactory(e,{record:t,schema:this}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.default=n}),define("models/TableSchemaModel",["require","exports","constants","utils","models/FieldSchemaModel"],function(e,t,i,l,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(t,e,n){var r=this;this._relations=[],this.db=l.ensureParam("db",t),this.name=l.ensureParamString("name",e),this.fields=Object.keys(l.ensureParam("schema",n)).map(function(e){return new o.default(r,e,n[e],!0===t.options.cascadeAsDefault)}),this._primaryKeyFields=this.fields.filter(function(e){return e.isPrimaryKey}),this._foreignKeyFields=this.fields.filter(function(e){return e.isForeignKey}),this._stampFields=this.fields.filter(function(e){return e.type===i.TYPE_MODIFIED})}return Object.defineProperty(e.prototype,"relations",{get:function(){return this._relations},enumerable:!0,configurable:!0}),e.prototype.connect=function(t){var n=this;t.forEach(function(e){return n._relations=n._relations.concat(e.fields.filter(function(e){return e.references===n.name}))}),this._foreignKeyFields.forEach(function(e){return e.connect(t)})},e.prototype.normalize=function(e,t){var s=this;if("object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var u=l.ensureParam("context",t);return u.output[this.name]||(u.output[this.name]={ids:[],byId:{},indexes:{}}),l.ensureArray(e).map(function(e){if(!l.isObject(e))throw new Error("Failed to normalize data. Given record is not a plain object.");var t=e,n=s.db.getNormalizer(s.name);n&&(t=n(t,u));var i=u.normalizePKs?s._normalizePrimaryKey(t):s._getPrimaryKey(t);if(!i)throw new Error('Failed to normalize primary key for record of type "'+s.name+'". Make sure record(s) have a primary key value before trying to insert or update a table.');var r=s.getForeignKeys(t),o=u.output[s.name];o.byId[i]||o.ids.push(i);var a=o.byId[i]=__assign({},t);return r.forEach(function(e){if("object"==typeof e.value&&e.refTable){var t=e.refTable.normalize(e.value,u);if(1<t.length)throw new Error('Invalid schema definition. The field "'+s.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');a[e.name]=e.value=t[0]}if(l.isValidID(e.value)){var n=l.asID(e.value),r=o.indexes[e.name]||(o.indexes[e.name]={unique:e.unique,values:{}});if(r.values[n]||(r.values[n]=[]),r.unique&&r.values.length)throw new Error('The insert/update operation violates the unique foreign key "'+s.name+"."+e.name+'".');r.values[n].push(i)}}),s.relations.forEach(function(e){if(e.relationName&&a[e.relationName]){var t=s.inferRelations(a[e.relationName],e,i);e.table.normalize(t,u),delete a[e.relationName]}}),i})},e.prototype.inferRelations=function(e,r,i){if(!r.relationName)return e;var o=r.table.fields.filter(function(e){return e.isForeignKey&&e!==r});return l.ensureArray(e).map(function(e){var t,n;return"number"!=typeof e&&"string"!=typeof e||(1===o.length?((t={})[o[0].name]=e,e=t):e={id:e}),__assign({},e,((n={})[r.name]=i,n))})},e.prototype.injectKeys=function(t,n){if(!t||"object"!=typeof t)return t;var e=this._primaryKeyFields;e.length||(e=this._foreignKeyFields),e.forEach(function(e){void 0===t[e.name]&&(t[e.name]=e.getRecordValue(n))})},e.prototype.getPrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return t},e.prototype.getForeignKeys=function(t){return this._foreignKeyFields.map(function(e){return{name:e.name,notNull:e.notNull,refTable:e.refTable,unique:e.unique,value:t[e.name]}})},e.prototype.isModified=function(n,r){if(0<this._stampFields.length)return this._stampFields.reduce(function(e,t){return e+(t.getValue(n)===t.getValue(r)?1:0)},0)!==this._stampFields.length;var e=this.db.getRecordComparer(this.name);return e?!e(n,r,this):n===r},e.prototype._getPrimaryKey=function(r){var e=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(e,t){var n=t.getValue(r);return e&&n?e+"_"+n:n},null);return l.isValidID(e)&&l.asID(e)},e.prototype._normalizePrimaryKey=function(e){var t=this._getPrimaryKey(e);if(t)return t;var n=this.db.getPkGenerator(this.name);if(n){var r=n(e,this);return r&&1===this._primaryKeyFields.length&&(e[this._primaryKeyFields[0].propName]=r),r}},e}();t.default=n}),define("models/index",["require","exports","models/RecordFieldModel","models/RecordModel","models/RecordSetModel","models/TableModel","models/TableSchemaModel"],function(e,t,n,r,i,o,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={RecordFieldModel:n.default,RecordModel:r.default,RecordSetModel:i.default,TableModel:o.default,TableSchemaModel:a.default}}),define("DefaultModelFactory",["require","exports","constants","errors","models/RecordFieldModel","models/RecordModel","models/RecordSetModel","models/TableModel","models/TableSchemaModel"],function(e,t,o,a,i,n,r,s,u){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var l=function(){function e(){this._recordClass={},this._defineProperty=function(e,t,n,r,i){if(void 0===i&&(i=!0),0<=o.RESERVED_PROPERTIES.indexOf(t))throw new Error(a.default.reservedProperty(n.table.name,t));Object.defineProperty(e.prototype,t,{get:function(){return i?this._fields[t]||(this._fields[t]=r(n,this)):r(n,this)}})}}return e.prototype.newTableSchema=function(e,t,n){return new u.default(e,t,n)},e.prototype.newTableModel=function(e,t,n){return new s.default(e,t,n)},e.prototype.newRecordModel=function(e,t){return new(this.createRecordModel(t.schema))(e,t)},e.prototype.newRecordSetModel=function(e,t,n){return new r.default(e,t,n)},e.prototype.getRecordBaseClass=function(e){return n.default},e.prototype.createRecordModel=function(e){var t=this;if(this._recordClass[e.name])return this._recordClass[e.name];var n=function(r){function e(e,t){var n=r.call(this,e,t)||this;return n._fields={},n}return __extends(e,r),e}(this.getRecordBaseClass(e));return e.fields.forEach(function(e){return(e.isForeignKey||!e.isPrimaryKey)&&t._defineProperty(n,e.propName,e,t._newRecordField.bind(t),!1)}),e.relations.forEach(function(e){return e.relationName&&t._defineProperty(n,e.relationName,e,e.unique?t._newRecordRelation.bind(t):t._newRecordSet.bind(t),!e.unique)}),this._recordClass[e.name]=n},e.prototype._newRecordField=function(e,t){if(!e.isForeignKey)return new i.default(e,t);if(!e.references)throw new Error(a.default.fkInvalidReference(e.name));var n=e.references&&t.table.session.tables[e.references];if(!n)throw new Error(a.default.fkReferenceNotInSession(e.name,e.references));var r=e.getRecordValue(t);return void 0===r?null:n.get(r)},e.prototype._newRecordSet=function(e,t){var n=t.table.session.tables[e.table.name];if(!n)throw new Error(a.default.tableNotInSession(e.table.name));return this.newRecordSetModel(n,e,t)},e.prototype._newRecordRelation=function(e,t){var n=t.table.session.tables[e.table.name];if(!n)throw new Error(a.default.tableNotInSession(e.table.name));var r=n.getIndex(e.name,t.id)[0];return void 0===r?null:this.newRecordModel(r,n)},e}();t.default=l}),define("index",["require","exports","Database","constants","models/index","DefaultModelFactory","utils"],function(e,n,r,t,i,o,a){"use strict";function s(e){for(var t in e)n.hasOwnProperty(t)||(n[t]=e[t])}Object.defineProperty(n,"__esModule",{value:!0}),n.createDatabase=function(e,t){return new r.default(e,t)},s(t),s(i),s(o),n.utils=a}),define("utils",["require","exports","errors"],function(e,n,r){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.toArray=function(t){return t?Array.isArray(t)?t:"object"==typeof t?Object.keys(t).map(function(e){return t[e]}):[]:[]},n.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},n.isObject=function(e){return null!==e&&!Array.isArray(e)&&"object"==typeof e},n.ensureParam=function(e,t){if(void 0===t)throw new Error(r.default.argument(e,"value"));return t},n.ensureParamString=function(e,t){if(null==t||"string"!=typeof t||0===t.length)throw new Error(r.default.argument(e,"string"));return t},n.ensureParamObject=function(e,t){if(!t||!n.isObject(t))throw new Error(r.default.argument(e,"object"));return t},n.ensureID=function(e){if(!n.isValidID(e))throw new Error('The given value is not a valid "id". An "id" must be a non-empty string or a number.');return n.asID(e)},n.isValidID=function(e){return null!=e&&("string"==typeof e&&0<e.length||"number"==typeof e)},n.asID=function(e){return"string"==typeof e?e:e.toString()},n.toObject=function(e,n){return e.reduce(function(e,t){return e[n(t)]=t,e},{})},n.mergeIds=function(e,t,n){var r,i={};for(r=0;r<e.length;r++)i[e[r]]=!0;for(r=0;r<t.length;r++){if(n&&i[t[r]])throw new Error('Id merge operation violates unique constraint for id: "'+t[r]+'"');i[t[r]]=!0}return Object.keys(i)},n.isEqual=function(e,t){if(e===t)return!0;var n=Object.keys(e),r=Object.keys(t),i=n.length;if(r.length!==i)return!1;for(var o=0;o<i;o++){var a=n[o];if(!(Array.isArray(e[a])&&Array.isArray(t[a])&&s(e[a],t[a]))&&e[a]!==t[a])return!1}return!0};var s=function(e,t){if(e===t)return!0;var n=e.length;if(t.length!==n)return!1;for(var r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}}),define("DatabaseSession",["require","exports","errors","utils"],function(e,t,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(t,e,n){void 0===t&&(t={});var r=this;this.state=t,this.db=e;var i=(this.options=n).tableSchemas||e.tables;this.tables=o.toObject(i.map(function(e){return r.db.factory.newTableModel(r,e,t[e.name])}),function(e){return e.schema.name})}return e.prototype.upsert=function(t){var n=this;if(this.options.readOnly)throw new Error(r.default.sessionReadonly());Object.keys(t.output).forEach(function(e){e!==t.schema.name&&n.tables[e].upsertNormalized(t.output[e])}),Object.keys(t.emits).forEach(function(e){e!==t.schema.name&&n.tables[e].upsert(t.emits[e])})},e.prototype.commit=function(){var i=this;if(this.options.readOnly)throw new Error(r.default.sessionReadonly());return Object.keys(this.tables).forEach(function(e){var t,n=i.state[e],r=i.tables[e].state;n!==r&&(i.state=__assign({},i.state,((t={})[e]=r,t)))}),this.state},e}();t.default=n}),define("Database",["require","exports","DatabaseSession","DefaultModelFactory","utils"],function(e,t,n,r,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i={cascadeAsDefault:!1},a=function(e,t,n){return e?"function"==typeof e?e:e[t]?e[t]:n:n},s=function(){function e(t,e){var n=this;this.getNormalizer=function(e){return a(n.options.onNormalize,e)},this.getPkGenerator=function(e){return a(n.options.onGeneratePK,e)},this.getRecordComparer=function(e){return a(n.options.onRecordCompare,e,o.isEqual)},o.ensureParamObject("schema",t),this.options=__assign({},i,e),this.factory=this.options.factory||new r.default,this.tables=Object.keys(t).map(function(e){return n.factory.newTableSchema(n,e,t[e])}),this.tables.forEach(function(e){return e.connect(n.tables)}),this._tableLookup=o.toObject(this.tables,function(e){return e.name})}return e.prototype.combineReducers=function(){for(var n=this,r=[],e=0;e<arguments.length;e++)r[e]=arguments[e];return function(e,t){return void 0===e&&(e={}),n.reduce(e,t,r)}},e.prototype.reduce=function(e,t,n,r){var i=this.createSession(e);return o.ensureArray(n).forEach(function(e){return e(i.tables,t,r)}),i.commit()},e.prototype.createSession=function(e,t){return new n.default(e,this,__assign({readOnly:!1},t))},e.prototype.selectTables=function(e){var t=this,n=Object.keys(e).filter(function(e){return t._tableLookup[e]}).map(function(e){return t._tableLookup[e]});return this.createSession(e,{readOnly:!0,tableSchemas:n}).tables},e}();t.default=s}),define("__tests__/Database.spec",["require","exports","constants","Database","DatabaseSession","errors","models/TableModel","utils"],function(e,t,i,o,n,r,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),describe("constructor",function(){test("throws if no schema given",function(){var e=o.default;expect(function(){return new e}).toThrow(r.default.argument("schema","object"))}),test("throws if invalid schema given",function(){var e=o.default;expect(function(){return new e([])}).toThrow(r.default.argument("schema","object"))}),test("creates table schemas",function(){return expect(new o.default({table1:{},table2:{}}).tables).toHaveLength(2)}),describe("with custom model factory",function(){var e={connect:jest.fn()},t={newTableSchema:jest.fn().mockReturnValue(e),newTableModel:jest.fn(),newRecordModel:jest.fn(),newRecordSetModel:jest.fn()};new o.default({table1:{}},{factory:t});test("calls factory.newTableSchema",function(){return expect(t.newTableSchema).toHaveBeenCalled()}),test("calls connect on new table schema",function(){return expect(e.connect).toHaveBeenCalled()})})}),describe("getNormalizer",function(){var t=jest.fn(function(e){return e}),n="test";test("returns undefined as default",function(){return expect(new o.default({}).getNormalizer(n)).toBeUndefined()}),test("returns general normalizer",function(){return expect(new o.default({},{onNormalize:t}).getNormalizer(n)).toStrictEqual(t)}),test("returns normalizer specific to schema",function(){var e;return expect(new o.default({},{onNormalize:(e={},e[n]=t,e)}).getNormalizer(n)).toStrictEqual(t)})}),describe("getPkGenerator",function(){var t=jest.fn(function(e){return e}),n="test";test("returns undefined as default",function(){return expect(new o.default({}).getPkGenerator(n)).toBeUndefined()}),test("returns general normalizer",function(){return expect(new o.default({},{onGeneratePK:t}).getPkGenerator(n)).toStrictEqual(t)}),test("returns normalizer specific to schema",function(){var e;return expect(new o.default({},{onGeneratePK:(e={},e[n]=t,e)}).getPkGenerator(n)).toStrictEqual(t)})}),describe("getRecordComparer",function(){var t=jest.fn(function(e){return e}),n="test";test("returns isEqual as default",function(){return expect(new o.default({}).getRecordComparer(n)).toStrictEqual(s.isEqual)}),test("returns general normalizer",function(){return expect(new o.default({},{onRecordCompare:t}).getRecordComparer(n)).toStrictEqual(t)}),test("returns normalizer specific to schema",function(){var e;return expect(new o.default({},{onRecordCompare:(e={},e[n]=t,e)}).getRecordComparer(n)).toStrictEqual(t)})}),describe("combineReducers",function(){var e=new o.default({}),t=jest.fn(),n=jest.fn(),r=e.combineReducers(t,n);test("returns a single reducer function",function(){return expect(r).toBeInstanceOf(Function)}),describe("when returned reducer is invoked",function(){r({},{}),test("calls combined reducers",function(){expect(t).toHaveBeenCalled(),expect(n).toHaveBeenCalled()})})}),describe("reduce",function(){var r=new o.default({table1:{id:{type:i.TYPE_PK}},table2:{}});describe("when called without args",function(){var e=r.reduce();test("returns initial state",function(){return expect(e).toEqual({table1:i.INITIAL_STATE,table2:i.INITIAL_STATE})})}),describe("when called with args",function(){var t={type:"ACTION"},n=jest.fn(function(e){e.table1.insert({id:1})});test("invokes given reducers",function(){r.reduce({},t,n),r.reduce({},t,[n]),expect(n).toBeCalledTimes(2)}),test("returns modified state",function(){var e=r.reduce({},t,n);expect(e).not.toEqual({table1:i.INITIAL_STATE,table2:i.INITIAL_STATE})})})}),describe("createSession",function(){var t=new o.default({}),e=t.createSession({});test("returns a immutable session instance",function(){return expect(e).toBeInstanceOf(n.default)}),test("readOnly is false as default",function(){return expect(e.options.readOnly).toEqual(!1)}),test("options are propagated",function(){var e={readOnly:!0,tableSchemas:[]};expect(t.createSession({},e).options).toEqual(e)})}),describe("selectTables",function(){var e=new o.default({table1:{id:{type:i.TYPE_PK}},table2:{}}),t=e.reduce(),n=e.selectTables(t);test("returns an map of table models",function(){expect(n.table1).toBeInstanceOf(a.default),expect(n.table2).toBeInstanceOf(a.default)}),test("tables are in readonly mode",function(){return expect(function(){return n.table1.insert({id:1})}).toThrow(r.default.sessionReadonly())})})}),define("models/__tests__/TableModel.spec",["require","exports","errors","models/TableModel"],function(e,t,n,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),describe("constructor",function(){test("throws if no session given",function(){var e=i.default;expect(function(){return new e}).toThrow(n.default.argument("session","object"))}),test("throws if no schema given",function(){var e=i.default;expect(function(){return new e({})}).toThrow(n.default.argument("schema","object"))}),test("throws if invalid state given",function(){var e=i.default;expect(function(){return new e({},{},null)}).toThrow(n.default.argument("state","object"));expect(function(){return new e({},{name:"test"},{})}).toThrow(n.default.tableInvalidState("test"))})}),describe("length",function(){var e=new i.default({},{},{byId:{},ids:["1","2","3"],indexes:{}});test("returns number of records in table",function(){return expect(e.length).toEqual(3)})}),describe("all",function(){var e={},t={db:{factory:{newRecordModel:jest.fn().mockReturnValue(e)}}},n=new i.default({},t,{byId:{},ids:["1","2","3"],indexes:{}});test("returns an array of all records in table",function(){return expect(n.all()).toEqual([e,e,e])})}),describe("values",function(){var e={},t={byId:{1:e,2:e,3:e},ids:["1","2","3"],indexes:{}},n=new i.default({},{},t);test("returns an array of all record values in table",function(){return expect(n.values()).toEqual([e,e,e])})}),describe("get",function(){var e={},t={name:"table",db:{factory:{newRecordModel:jest.fn().mockReturnValue(e)}}},n={byId:{1:e,2:e,3:e},ids:["1","2","3"],indexes:{}},r=new i.default({},t,n);test("returns a single record id",function(){return expect(r.get(1)).toEqual(e)}),test("returns undefined if not in table",function(){return expect(r.get(0)).toBeUndefined()}),test("returns undefined if invalid id given",function(){expect(r.get(null)).toBeUndefined(),expect(r.get(void 0)).toBeUndefined(),expect(r.get({})).toBeUndefined(),expect(r.get([])).toBeUndefined(),expect(r.get(NaN)).toBeUndefined()})}),describe("getByFK",function(){var e={},t={name:"table",db:{factory:{newRecordModel:jest.fn().mockReturnValue(e)}}},n={byId:{1:e,2:e,3:e},ids:["1","2","3"],indexes:{}},r=new i.default({},t,n);test("returns a single record id",function(){return expect(r.getByFK(1)).toEqual(e)}),test("returns undefined if not in table",function(){return expect(r.get(0)).toBeUndefined()}),test("returns undefined if invalid id given",function(){expect(r.get(null)).toBeUndefined(),expect(r.get(void 0)).toBeUndefined(),expect(r.get({})).toBeUndefined(),expect(r.get([])).toBeUndefined(),expect(r.get(NaN)).toBeUndefined()})})});