var __assign=this&&this.__assign||Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])};return function(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}}();define("def",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})}),define("utils",["require","exports"],function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toArray=function(t){return t?Array.isArray(t)?t:"object"==typeof t?Object.keys(t).map(function(e){return t[e]}):[]:[]},t.ensureArray=function(e){return e?Array.isArray(e)?e:[e]:[]},t.ensureParam=function(e,t){if(void 0===t)throw new Error('Missing a valid value for the argument "'+e+'"');return t},t.ensureParamString=function(e,t){if(null==t||"string"!=typeof t||0===t.length)throw new Error('Missing a valid string for the argument "'+e+'"');return t},t.ensureID=function(e){if(!t.isValidID(e))throw new Error('The given value is not a valid "id". An "id" must be a non-empty string or a number.');return t.asID(e)},t.isValidID=function(e){return null!=e&&("string"==typeof e&&0<e.length||"number"==typeof e)},t.asID=function(e){return"string"==typeof e?e:e.toString()},t.toObject=function(e,r){return e.reduce(function(e,t){return e[r(t)]=t,e},{})},t.mergeIds=function(e,t,r){var n,i={};for(n=0;n<e.length;n++)i[e[n]]=!0;for(n=0;n<t.length;n++){if(r&&i[t[n]])throw new Error('Id merge operation violates unique constraint for id: "'+t[n]+'"');i[t[n]]=!0}return Object.keys(i)},t.isEqual=function(e,t){if(e===t)return!0;var r=Object.keys(e),n=Object.keys(t),i=r.length;if(n.length!==i)return!1;for(var a=0;a<i;a++){var o=r[a];if(!(Array.isArray(e[o])&&Array.isArray(t[o])&&s(e[o],t[o]))&&e[o]!==t[o])return!1}return!0};var s=function(e,t){if(e===t)return!0;var r=e.length;if(t.length!==r)return!1;for(var n=0;n<r;n++)if(e[n]!==t[n])return!1;return!0}}),define("models",["require","exports","utils"],function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){this.output={},this.emits={},this.schema=e,this.db=e.db,this.normalizePKs=t}return e.prototype.emit=function(e,t){this.emits[e]=this.emits[e]||[],this.emits[e].push(t)},e}();t.DbNormalizeContext=o;var r=function(){function e(e,t,r){void 0===t&&(t={ids:[],byId:{},indexes:{}}),this.dirty=!1,this.session=s.ensureParam("session",e),this.state=s.ensureParam("state",t),this.schema=s.ensureParam("schema",r),this.state.name||(this.state.name=r.name)}return e.prototype.all=function(){var t=this;return this.state.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},Object.defineProperty(e.prototype,"length",{get:function(){return this.state.ids.length},enumerable:!0,configurable:!0}),e.prototype.getValues=function(){var t=this;return this.state.ids.map(function(e){return t.state.byId[e]})},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.map=function(e){return this.all().map(e)},e.prototype.index=function(e,t){return s.ensureParamString("value",e),s.ensureParamString("fk",t),this.state.indexes[e]&&this.state.indexes[e].values[t]?this.state.indexes[e].values[t]:[]},e.prototype.get=function(e){if(!this.exists(e))throw new Error('No "'+this.schema.name+'" record with id: '+e+" exists.");return this.schema.db.factory.newRecordModel(s.asID(e),this)},e.prototype.getOrDefault=function(e){return this.exists(e)?this.get(e):null},e.prototype.getByFk=function(t,e){s.ensureParam("fieldName",t),e=s.ensureID(e);var r=this.schema.fields.filter(function(e){return e.isForeignKey&&e.name===t})[0];if(!r)throw new Error("No foreign key named: "+t+' in the schema: "'+this.schema.name+'".');return new a(this,r,{id:e})},e.prototype.getFieldValue=function(e,t){var r=this.getOrDefault(e);return r?r.value[t]:void 0},e.prototype.getValue=function(e){return s.isValidID(e)?this.state.byId[e]:void 0},e.prototype.exists=function(e){return!!s.isValidID(e)&&void 0!==this.state.byId[s.asID(e)]},e.prototype.insert=function(e){return this.insertMany(e)[0]},e.prototype.insertMany=function(e){return this._normalizedAction(e,this.insertNormalized,!0)},e.prototype.update=function(e){return this.updateMany(e)[0]},e.prototype.updateMany=function(e){return this._normalizedAction(e,this.updateNormalized,!1)},e.prototype.upsert=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)[0]},e.prototype.upsertRaw=function(e){return this._normalizedAction(e,this.upsertNormalized,!0)},e.prototype.delete=function(e){if("string"!=typeof e&&"number"!=typeof e&&(e=this.schema.getPrimaryKey(e)),!this.exists(e))return!1;e=s.asID(e),this._deleteCascade(e);var t=__assign({},this.state.byId),r=this.state.ids.slice(),n=__assign({},this.state.indexes),i=t[e];delete t[e];var a=r.indexOf(e);return 0<=a&&r.splice(a,1),i&&this._cleanIndexes(e,i,n),this.dirty=!0,this.state=__assign({},this.state,{byId:t,ids:r,indexes:n}),!0},e.prototype.deleteAll=function(){this.length&&this.all().forEach(function(e){return e.delete()})},e.prototype.insertNormalized=function(e){var t=this;return s.ensureParam("table",e),this.dirty=!0,this.state=__assign({},this.state,{ids:s.mergeIds(this.state.ids,e.ids,!0),byId:__assign({},this.state.byId,e.byId)}),this._updateIndexes(e),e.ids.map(function(e){return t.schema.db.factory.newRecordModel(e,t)})},e.prototype.updateNormalized=function(n){var i=this;s.ensureParam("table",n);var a=__assign({},this.state),o=!1,e=Object.keys(n.byId).map(function(e){if(!i.state.byId[e])throw new Error('Failed to apply update. No "'+i.schema.name+'" record with id: '+e+" exists.");var t=a.byId[e],r=__assign({},t,n.byId[e]);return i.schema.isModified(t,r)&&(a.byId[e]=r,o=!0),i.schema.db.factory.newRecordModel(e,i)});return o&&(this.dirty=!0,this.state=a,this._updateIndexes(n)),e},e.prototype.upsertNormalized=function(t){var r=this;s.ensureParam("table",t);var n={ids:[],byId:{},indexes:{}},i={ids:[],byId:{},indexes:{}};t.ids.forEach(function(e){r.exists(e)?(n.ids.push(e),n.byId[e]=t.byId[e]):(i.ids.push(e),i.byId[e]=t.byId[e])});var e=(n.ids.length?this.updateNormalized(n):[]).concat(i.ids.length?this.insertNormalized(i):[]);return this._updateIndexes(t),e},e.prototype._normalizedAction=function(e,t,r){s.ensureParam("data",e),s.ensureParam("action",t);var n=new o(this.schema,r);this.schema.normalize(e,n);var i=n.output[this.schema.name],a=i?t.call(this,i):[];return this.session.upsert(n),a},e.prototype._updateIndexes=function(a){var o=this;Object.keys(a.indexes).forEach(function(n){var i=o.state.indexes[n]||(o.state.indexes[n]={unique:a.indexes[n].unique,values:{}});Object.keys(a.indexes[n].values).forEach(function(e){var t=i.values[e]||(i.values[e]=[]),r=s.mergeIds(t,a.indexes[n].values[e],!1);if(i.unique&&1<r.length)throw new Error('The insert/update operation violates the unique foreign key "'+o.schema.name+"."+n+'".');i.values[e]=r})})},e.prototype._cleanIndexes=function(n,e,i){this.schema.getForeignKeys(e).forEach(function(e){var t=-1;if(e.value&&i[e.name]&&i[e.name].values[e.value]&&(t=i[e.name].values[e.value].indexOf(n)),0<=t){var r=i[e.name].values[e.value].slice();r.splice(t,1),i[e.name].values[e.value]=r}else i[e.name]&&(delete i[e.name].values[n],0===Object.keys(i[e.name].values).length&&delete i[e.name])})},e.prototype._deleteCascade=function(e){var t=this.schema.relations.filter(function(e){return e.relationName&&e.cascade});if(t.length){var r=this.get(e);r&&t.forEach(function(e){var t=r[e.relationName];t&&t.delete()})}},e}();t.TableModel=r;var n=function(){function e(e,t){this.id=s.ensureParam("id",e),this.table=s.ensureParam("table",t)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.table.getValue(this.id)||{}},set:function(e){this.update(e)},enumerable:!0,configurable:!0}),e.prototype.delete=function(){this.table.delete(this.id)},e.prototype.update=function(e){return this.table.schema.injectKeys(e,this),this.table.update(e),this},e}();t.RecordModel=n;var i=function(){function e(e,t){this.schema=s.ensureParam("schema",e),this.record=s.ensureParam("record",t),this.name=s.ensureParamString("schema.name",e.name)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.schema.getRecordValue(this.record)},enumerable:!0,configurable:!0}),e}();t.RecordFieldModel=i;var a=function(){function e(e,t,r){this.table=s.ensureParam("table",e),this.schema=s.ensureParam("schema",t),this.owner=s.ensureParam("owner",r)}return Object.defineProperty(e.prototype,"value",{get:function(){return this.map(function(e){return e.value})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"ids",{get:function(){return this.table.index(this.schema.name,this.owner.id)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this.ids.length},enumerable:!0,configurable:!0}),e.prototype.all=function(){var t=this;return this.ids.map(function(e){return t.table.schema.db.factory.newRecordModel(e,t.table)})},e.prototype.map=function(e){return this.all().map(e)},e.prototype.filter=function(e){return this.all().filter(e)},e.prototype.add=function(e){this.table.insert(this._normalize(e))},e.prototype.remove=function(e){var r=this;this._normalize(e).forEach(function(e){var t=r.table.schema.getPrimaryKey(e);r.table.delete(t)})},e.prototype.update=function(e){return this.table.update(this._normalize(e)),this},e.prototype.delete=function(){var t=this;this.ids.forEach(function(e){return t.table.delete(e)})},e.prototype._normalize=function(e){return this.table.schema.inferRelations(e,this.schema,this.owner.id)},e}();t.RecordSetModel=a}),define("index",["require","exports","utils","factory","models"],function(e,r,a,n,t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.DefaultModelFactory=n.DefaultModelFactory,function(e){for(var t in e)r.hasOwnProperty(t)||(r[t]=e[t])}(t);var i={cascadeAsDefault:!1};r.createDatabase=function(e,t){return new o(e,t)};var o=function(){function e(t,e){var r=this;a.ensureParam("schema",t),this.options=__assign({},i,e),this.normalizeHooks=this.options.onNormalize||{},this.factory=this.options.factory||new n.DefaultModelFactory,this.onMissingPk=this.options.onMissingPk||void 0,this.tables=Object.keys(t).map(function(e){return r.factory.newTableSchema(r,e,t[e])}),this.tables.forEach(function(e){return e.connect(r.tables)})}return e.prototype.combineReducers=function(){for(var r=this,n=[],e=0;e<arguments.length;e++)n[e]=arguments[e];return function(e,t){return void 0===e&&(e={}),r.reduce(e,t,n)}},e.prototype.reduce=function(e,t,r,n){var i=this.createSession(e);return a.ensureArray(r).forEach(function(e){return e(i.tables,t,n)}),i.commit()},e.prototype.createSession=function(e,t){return new s(e,this,__assign({readOnly:!1},t))},e.prototype.selectTables=function(e){var r=this,t=Object.keys(e).map(function(t){var e=r.tables.filter(function(e){return e.name===t})[0];if(!e)throw new Error('Could not select table. The table "'+t+'" is not defined in schema.');return e});return s.Partial(e,t,this)},e.prototype.selectTable=function(e,t){var r,n=t||e.name;if(!n)throw new Error("Failed to select table. Could not identify table schema.");return this.selectTables((r={},r[n]=e,r))[n]},e}();r.Database=o;var s=function(){function n(t,e,r){void 0===t&&(t={});var n=this;this.state=t,this.db=e,this.options=r,this.tables=a.toObject(e.tables.map(function(e){return n.db.factory.newTableModel(n,t[e.name],e)}),function(e){return e.schema.name})}return n.prototype.upsert=function(t){var r=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");Object.keys(t.output).forEach(function(e){e!==t.schema.name&&r.tables[e].upsertNormalized(t.output[e])}),Object.keys(t.emits).forEach(function(e){e!==t.schema.name&&r.tables[e].upsert(t.emits[e])})},n.prototype.commit=function(){var i=this;if(this.options.readOnly)throw new Error("Invalid attempt to alter a readonly session.");return Object.keys(this.tables).forEach(function(e){var t,r=i.state[e],n=i.tables[e].state;r!==n&&(i.state=__assign({},i.state,((t={})[e]=n,t)))}),this.state},n.Partial=function(e,t,r){return new n(e,{tables:t,options:r.options,factory:r.factory,normalizeHooks:r.normalizeHooks},{readOnly:!0}).tables},n}();r.DatabaseSession=s}),define("schema",["require","exports","utils"],function(e,t,l){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(t,e,r){var n=this;this._relations=[],this.db=l.ensureParam("db",t),this.name=l.ensureParamString("name",e),this.fields=Object.keys(l.ensureParam("schema",r)).map(function(e){return new i(n,e,r[e],!0===t.options.cascadeAsDefault)}),this._primaryKeyFields=this.fields.filter(function(e){return e.isPrimaryKey}),this._foreignKeyFields=this.fields.filter(function(e){return e.isForeignKey}),this._stampFields=this.fields.filter(function(e){return"MODIFIED"===e.type})}return Object.defineProperty(e.prototype,"relations",{get:function(){return this._relations},enumerable:!0,configurable:!0}),e.prototype.connect=function(t){var r=this;t.forEach(function(e){return r._relations=r._relations.concat(e.fields.filter(function(e){return e.references===r.name}))}),this._foreignKeyFields.forEach(function(e){return e.connect(t)})},e.prototype.normalize=function(e,t){var s=this;if("object"!=typeof e&&!Array.isArray(e))throw new Error("Failed to normalize data. Given argument is not a plain object nor an array.");var u=l.ensureParam("context",t);return u.output[this.name]||(u.output[this.name]={ids:[],byId:{},indexes:{}}),l.ensureArray(e).map(function(e){if("object"!=typeof e)throw new Error("Failed to normalize data. Given record is not a plain object.");var t=s.db.normalizeHooks?s.db.normalizeHooks[s.name]:null;t&&(e=t(e,u));var i=u.normalizePKs?s._normalizePrimaryKey(e):s._getPrimaryKey(e);if(!i)throw new Error('Failed to normalize primary key for record of type "'+s.name+'". Make sure record(s) have a primary key value before trying to insert or update a table.');var r=s.getForeignKeys(e),a=u.output[s.name];a.byId[i]||a.ids.push(i);var o=a.byId[i]=__assign({},e);return r.forEach(function(e){if("object"==typeof e.value&&e.refTable){var t=e.refTable.normalize(e.value,u);if(1<t.length)throw new Error('Invalid schema definition. The field "'+s.name+"."+e.name+'" is referencing table "'+e.refTable.name+'", but the given data is an array.');o[e.name]=e.value=t[0]}if(l.isValidID(e.value)){var r=l.asID(e.value),n=a.indexes[e.name]||(a.indexes[e.name]={unique:e.unique,values:{}});if(n.values[r]||(n.values[r]=[]),n.unique&&n.values.length)throw new Error('The insert/update operation violates the unique foreign key "'+s.name+"."+e.name+'".');n.values[r].push(i)}}),s.relations.forEach(function(e){if(e.relationName&&o[e.relationName]){var t=s.inferRelations(o[e.relationName],e,i);e.table.normalize(t,u),delete o[e.relationName]}}),i})},e.prototype.inferRelations=function(e,n,i){if(!n.relationName)return e;var a=n.table.fields.filter(function(e){return e.isForeignKey&&e!==n});return l.ensureArray(e).map(function(e){var t,r;return"number"!=typeof e&&"string"!=typeof e||(1===a.length?((t={})[a[0].name]=e,e=t):e={id:e}),__assign({},e,((r={})[n.name]=i,r))})},e.prototype.injectKeys=function(t,r){if(!t||"object"!=typeof t)return t;var e=this._primaryKeyFields;e.length||(e=this._foreignKeyFields),e.forEach(function(e){void 0===t[e.name]&&(t[e.name]=e.getRecordValue(r))})},e.prototype.getPrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t)throw new Error('Failed to get primary key for record of type "'+this.name+'".');return t},e.prototype._getPrimaryKey=function(n){var e=(this._primaryKeyFields.length?this._primaryKeyFields:this._foreignKeyFields).reduce(function(e,t){var r=t.getValue(n);return e&&r?e+"_"+r:r},null);return l.isValidID(e)&&l.asID(e)},e.prototype._normalizePrimaryKey=function(e){var t=this._getPrimaryKey(e);if(!t&&this.db.onMissingPk){var r=this.db.onMissingPk(e,this);r&&(1===this._primaryKeyFields.length&&(e[this._primaryKeyFields[0].propName]=r),t=r)}return t},e.prototype.getForeignKeys=function(t){return this._foreignKeyFields.map(function(e){return{name:e.name,value:t[e.name],refTable:e.refTable,unique:e.unique,notNull:e.notNull}})},e.prototype.isModified=function(r,n){return 0<this._stampFields.length?this._stampFields.reduce(function(e,t){return e+(t.getValue(r)===t.getValue(n)?1:0)},0)!==this._stampFields.length:!l.isEqual(r,n)},e}();t.TableSchemaModel=r;var i=function(){function e(e,t,r,n){this.table=l.ensureParam("table",e),this.type=r.type||"ATTR",this.name=t,this.propName=r.propName||t,this._valueFactory=r.value?r.value.bind(this):null,this.isPrimaryKey="PK"===r.type,this.isForeignKey=null!==r.references&&void 0!==r.references,this.isPrimaryKey||this.isForeignKey?(this.references=r.references,this.relationName=r.relationName,this.cascade=void 0===r.cascade?n:!0===r.cascade,this.unique=!0===r.unique,this.notNull=void 0===r.notNull||!0===r.notNull):(this.cascade=!1,this.unique=!1,this.notNull=!0===r.notNull)}return Object.defineProperty(e.prototype,"refTable",{get:function(){return this._refTable},enumerable:!0,configurable:!0}),e.prototype.connect=function(e){var t=this;if(this.references&&(this._refTable=e.filter(function(e){return e.name===t.references})[0],!this._refTable))throw new Error('The field schema "'+this.table.name+"."+this.name+'" has an invalid reference to unknown table "'+this.references+'".')},e.prototype.getValue=function(e,t){return this._valueFactory?this._valueFactory(e,{schema:this,record:t}):e[this.name]},e.prototype.getRecordValue=function(e){return this.getValue(e.value,e)},e}();t.FieldSchemaModel=i}),define("factory",["require","exports","models","schema"],function(e,t,i,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._recordClass={}}return e.prototype.newTableSchema=function(e,t,r){return new n.TableSchemaModel(e,t,r)},e.prototype.newTableModel=function(e,t,r){return new i.TableModel(e,t,r)},e.prototype.newRecordModel=function(e,t){return new(this._createRecordModel(t.schema))(e,t)},e.prototype.newRecordField=function(e,t){if(!e.isForeignKey)return new i.RecordFieldModel(e,t);var r=e.references&&t.table.session.tables[e.references];if(!r)throw new Error('The foreign key: "'+e.name+'" references an unregistered table: "'+e.references+'" in the current session.');var n=e.getRecordValue(t);return void 0===n?null:r.getOrDefault(n)},e.prototype.newRecordSet=function(e,t){var r=t.table.session.tables[e.table.name];if(!r)throw new Error('The table: "'+e.table.name+'" does not exist in the current session.');return new i.RecordSetModel(r,e,t)},e.prototype.newRecordRelation=function(e,t){var r=t.table.session.tables[e.table.name];if(!r)throw new Error('The table: "'+e.table.name+'" does not exist in the current session.');var n=r.index(e.name,t.id)[0];return void 0===n?null:this.newRecordModel(n,r)},e.prototype.getRecordBaseClass=function(e){return i.RecordModel},e.prototype._createRecordModel=function(e){var t=this;if(this._recordClass[e.name])return this._recordClass[e.name];var i=function(n){function e(e,t){var r=n.call(this,e,t)||this;return r.__fields={},r}return __extends(e,n),e}(this.getRecordBaseClass(e)),r=function(e,t,r,n){if(void 0===n&&(n=!0),"id"===e)throw new Error('The property "'+t.table.name+'.id" is a reserved name. Please specify another name using the "propName" definition.');Object.defineProperty(i.prototype,e,{get:function(){return n?this.__fields[e]||(this.__fields[e]=r(t,this)):r(t,this)}})};return e.fields.forEach(function(e){return(e.isForeignKey||!e.isPrimaryKey)&&r(e.propName,e,t.newRecordField.bind(t),!1)}),e.relations.forEach(function(e){return e.relationName&&r(e.relationName,e,e.unique?t.newRecordRelation.bind(t):t.newRecordSet.bind(t),!e.unique)}),this._recordClass[e.name]=i},e}();t.DefaultModelFactory=r});